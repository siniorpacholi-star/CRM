<!-- app/templates/client/user_card.html -->
{% extends "client_base.html" %}
{% block title %}Карточка пользователя - CRM Бухгалтерия{% endblock %}
{% block content %}
<div class="container-fluid p-0">

  <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="fas fa-id-card me-2"></i>Карточка пользователя</h1>
    <a class="btn btn-secondary" href="/client/{{ client.id }}/users">
      <i class="fas fa-arrow-left me-1"></i>К списку пользователей
    </a>
  </div>

  <div class="row">
    <!-- Левая часть: данные пользователя -->
    <div class="col-md-8">
      <div class="card shadow-sm">
        <div class="card-body">
          <form id="userCardForm" method="post" action="/client/{{ client.id }}/users/{{ user.id }}/update">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">ФИО *</label>
                <input type="text" class="form-control" name="full_name" value="{{ user.full_name }}" required disabled>
              </div>
              <div class="col-md-6">
                <label class="form-label">Email *</label>
                <input type="email" class="form-control" name="email" value="{{ user.email }}" required disabled>
              </div>
              <div class="col-md-4">
                <label class="form-label">Логин *</label>
                <input type="text" class="form-control" name="login" value="{{ user.login }}" required disabled>
              </div>
              <div class="col-md-4">
                <label class="form-label">Телефон</label>
                <input type="tel" class="form-control" name="phone" value="{{ user.phone or '' }}" disabled>
              </div>
              <div class="col-md-4">
                <label class="form-label">Профиль</label>
                <select class="form-select" name="profile_id" disabled>
                  <option value="">— Не выбран —</option>
                  {% for p in profiles %}
                  <option value="{{ p.id }}" {% if user.main_profile_id == p.id %}selected{% endif %}>
                    {{ p.name }}
                  </option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Статус</label>
                <select class="form-select" name="is_active" disabled>
                  <option value="1" {% if user.is_active %}selected{% endif %}>Активен</option>
                  <option value="0" {% if not user.is_active %}selected{% endif %}>Неактивен</option>
                </select>
              </div>
            </div>

            <div class="d-flex gap-2 mt-4">
              <button type="button" id="editBtn" class="btn btn-primary-custom">
                <i class="fas fa-pen me-1"></i>Редактировать
              </button>
              <button type="submit" id="saveBtn" class="btn btn-success" style="display:none;">
                <i class="fas fa-save me-1"></i>Сохранить
              </button>
              <button type="button" id="cancelBtn" class="btn btn-outline-secondary" style="display:none;">
                Отмена
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Правая часть: доступные клиенты -->
    <div class="col-md-4">
      <div class="card shadow-sm">
        <div class="card-header bg-dark text-white">
          <i class="fas fa-building me-2"></i>Клиенты (отображение в календаре)
        </div>
        <div class="card-body">
          {% if clients_with_access and clients_with_access|length > 0 %}
          <div class="list-group">
            {% for c in clients_with_access %}
            <label class="list-group-item d-flex align-items-center justify-content-between">
              <span class="me-3">{{ c.full_name }}</span>
              <div class="form-check form-switch m-0">
                <input class="form-check-input client-toggle" type="checkbox"
                       data-client-id="{{ c.id }}" {% if c.can_view %}checked{% endif %}>
              </div>
            </label>
            {% endfor %}
          </div>
          <div class="text-end mt-3">
            <button class="btn btn-primary-custom" id="saveAccessBtn">
              <i class="fas fa-save me-1"></i>Сохранить доступы
            </button>
          </div>
          {% else %}
          <div class="text-muted">Клиенты не найдены.</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  // поведение для редактирования левой формы
  const form = document.getElementById('userCardForm');
  const editBtn = document.getElementById('editBtn');
  const saveBtn = document.getElementById('saveBtn');
  const cancelBtn = document.getElementById('cancelBtn');

  function setDisabled(disabled) {
    form.querySelectorAll('input, select, textarea').forEach(el => {
      if (el.name) el.disabled = disabled;
    });
  }

  const initial = {};
  form.querySelectorAll('input, select, textarea').forEach(el => {
    if (!el.name) return;
    if (el.tagName === 'SELECT') {
      initial[el.name] = el.value;
    } else if (el.type === 'checkbox' || el.type === 'radio') {
      initial[el.name] = el.checked;
    } else {
      initial[el.name] = el.value;
    }
  });

  editBtn?.addEventListener('click', () => {
    setDisabled(false);
    editBtn.style.display = 'none';
    saveBtn.style.display = 'inline-block';
    cancelBtn.style.display = 'inline-block';
  });

  cancelBtn?.addEventListener('click', () => {
    for (const [k, v] of Object.entries(initial)) {
      const el = form.querySelector(`[name="${k}"]`);
      if (!el) continue;
      if (el.tagName === 'SELECT') el.value = v;
      else if (el.type === 'checkbox' || el.type === 'radio') el.checked = v;
      else el.value = v;
    }
    setDisabled(true);
    editBtn.style.display = 'inline-block';
    saveBtn.style.display = 'none';
    cancelBtn.style.display = 'none';
  });

  setDisabled(true);

  // сохранение прав доступа (правая панель)
  const saveAccessBtn = document.getElementById('saveAccessBtn');
  saveAccessBtn?.addEventListener('click', async () => {
    const toggles = Array.from(document.querySelectorAll('.client-toggle'));
    const payload = {
      access: toggles.map(t => ({
        client_id: parseInt(t.dataset.clientId),
        can_view: !!t.checked
      }))
    };
    try {
      const resp = await fetch('/client/{{ client.id }}/users/{{ user.id }}/access', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      if (!resp.ok) {
        const d = await resp.json().catch(() => ({}));
        alert('Ошибка сохранения прав: ' + (d.detail || resp.statusText));
        return;
      }
      alert('Права сохранены');
    } catch (e) {
      console.error(e);
      alert('Ошибка сети при сохранении прав');
    }
  });
})();
</script>
{% endblock %}
