<!-- app/templates/client/calendar_handbook.html -->
{% extends "client_base.html" %}

{% block title %}Справочник календаря - CRM Бухгалтерия{% endblock %}

{% block content %}
<div class="container-fluid p-0">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2"><i class="fas fa-book me-2"></i>Справочник календаря</h1>
        <button class="btn btn-primary-custom" onclick="fillCalendarHandbook()">
            <i class="fas fa-sync-alt me-2"></i>Заполнить справочник
        </button>
    </div>

    {% if calendar_entries %}
    <div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0">Записи справочника календаря</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>Клиент</th>
                            <th>Отчет</th>
                            <th>Период</th>
                            <th>Срок сдачи</th>
                            <th>Статус</th>
                            <th>Дата создания</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for entry in calendar_entries %}
                        <tr>
                            <td>{{ entry.client.organization_name }}</td>
                            <td>{{ entry.report.short_name }}</td>
                            <td>{{ entry.period }}</td>
                            <td>{{ entry.due_date.strftime('%d.%m.%Y') }}</td>
                            <td>
                                <span class="badge 
                                    {% if entry.status == 'не сдан' %}bg-danger
                                    {% elif entry.status == 'подготовлен' %}bg-warning
                                    {% elif entry.status == 'сдан' %}bg-success
                                    {% else %}bg-secondary{% endif %}">
                                    {{ entry.status }}
                                </span>
                            </td>
                            <td>{{ entry.created_at.strftime('%d.%m.%Y %H:%M') }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% else %}
    <div class="text-center py-5">
        <i class="fas fa-book fa-4x text-muted mb-3"></i>
        <h3>Справочник календаря пуст</h3>
        <p class="text-muted">Нажмите кнопку "Заполнить справочник" для создания записей</p>
    </div>
    {% endif %}
</div>

<script>
// Заполнение справочника календаря
async function fillCalendarHandbook() {
    if (!confirm('Вы уверены, что хотите заполнить справочник календаря? Будут добавлены только новые записи.')) return;
    
    try {
        const response = await fetch('/client/{{ client.id }}/calendar_handbook/fill', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const result = await response.json();
        
        if (response.ok) {
            alert(result.message);
            location.reload();
        } else {
            alert('Ошибка: ' + (result.detail || 'Неизвестная ошибка'));
        }
    } catch (error) {
        console.error('Ошибка заполнения справочника:', error);
        alert('Ошибка заполнения справочника: ' + error.message);
    }
}
</script>
{% endblock %}