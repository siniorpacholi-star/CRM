{% extends "base.html" %}

{% block title %}Админ панель - CRM Бухгалтерия{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Сайдбар -->
        <div class="col-md-3 col-lg-2 d-md-block bg-dark sidebar collapse">
            <div class="position-sticky pt-3">
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link active text-white" href="#">
                            <i class="fas fa-users me-2"></i>
                            Управление клиентами
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white" href="#">
                            <i class="fas fa-cog me-2"></i>
                            Настройки
                        </a>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Основной контент -->
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2"><i class="fas fa-tachometer-alt me-2"></i>Админ панель</h1>
            </div>

            <!-- Статистика -->
            <div class="row">
                <div class="col-md-3 mb-4">
                    <div class="card text-white bg-primary">
                        <div class="card-body">
                            <h5 class="card-title">Всего клиентов</h5>
                            <h2 id="clients-count" class="card-text">0</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-4">
                    <div class="card text-white bg-success">
                        <div class="card-body">
                            <h5 class="card-title">Активные</h5>
                            <h2 id="active-count" class="card-text">0</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-4">
                    <div class="card text-white bg-info">
                        <div class="card-body">
                            <h5 class="card-title">С Базой данных</h5>
                            <h2 id="db-count" class="card-text">0</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-4">
                    <div class="card text-white bg-warning">
                        <div class="card-body">
                            <h5 class="card-title">Требуют БД</h5>
                            <h2 id="no-db-count" class="card-text">0</h2>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Управление клиентами -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-users me-2"></i>Список клиентов
                    </h5>
                    <button class="btn btn-primary-custom" data-bs-toggle="modal" data-bs-target="#addClientModal">
                        <i class="fas fa-plus me-2"></i>Добавить клиента
                    </button>
                </div>
                <div class="card-body">
                    <div id="loading-message" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Загрузка...</span>
                        </div>
                        <p class="mt-3 text-muted">Загрузка данных...</p>
                    </div>
                    <div class="table-responsive" id="clients-table-container" style="display: none;">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>Компания</th>
                                    <th>Контактное лицо</th>
                                    <th>Email</th>
                                    <th>Телефон</th>
                                    <th>Логин</th>
                                    <th>Профиль</th>
                                    <th>База данных</th>
                                    <th>Статус</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody id="clients-tbody">
                            </tbody>
                        </table>
                    </div>
                    <div id="empty-state" class="text-center py-5" style="display: none;">
                        <i class="fas fa-users fa-3x text-muted mb-3"></i>
                        <h4>Клиенты не найдены</h4>
                        <p class="text-muted">Добавьте первого клиента, нажав кнопку "Добавить клиента"</p>
                    </div>
                    <div id="error-message" class="alert alert-danger" style="display: none;">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Ошибка загрузки данных. Пожалуйста, обновите страницу.
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- Модальное окно добавления клиента -->
<div class="modal fade" id="addClientModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-user-plus me-2"></i>Добавить нового клиента</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="add-client-form">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Название компании *</label>
                                <input type="text" class="form-control" name="company_name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Контактное лицо *</label>
                                <input type="text" class="form-control" name="contact_person" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Email *</label>
                                <input type="email" class="form-control" name="email" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Телефон *</label>
                                <input type="tel" class="form-control" name="phone" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Логин для системы *</label>
                                <input type="text" class="form-control" name="login" required>
                                <div class="form-text">Уникальный логин для доступа в систему</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Пароль *</label>
                                <input type="password" class="form-control" name="password" required>
                                <div class="form-text">Пароль для доступа в систему клиента</div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Дополнительные заметки</label>
                        <textarea class="form-control" name="notes" rows="2" placeholder="Любая дополнительная информация о клиенте..."></textarea>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="createDatabase" name="create_database">
                        <label class="form-check-label" for="createDatabase">Создать базу данных автоматически</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary-custom" onclick="addClient()">
                    <i class="fas fa-save me-2"></i>Создать клиента
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Загрузка списка клиентов
async function loadClients() {
    try {
        // Показываем загрузку, скрываем остальное
        document.getElementById('loading-message').style.display = 'block';
        document.getElementById('clients-table-container').style.display = 'none';
        document.getElementById('empty-state').style.display = 'none';
        document.getElementById('error-message').style.display = 'none';
        
        const response = await fetch('/api/admin/clients');
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const clients = await response.json();
        
        console.log('Получены клиенты:', clients);
        
        const tbody = document.getElementById('clients-tbody');
        tbody.innerHTML = '';
        
        let activeCount = 0;
        let dbCount = 0;
        let noDbCount = 0;
        
        // Всегда скрываем сообщение о загрузке после получения ответа
        document.getElementById('loading-message').style.display = 'none';
        
        if (clients && Array.isArray(clients) && clients.length > 0) {
            clients.forEach(client => {
                if (client.is_active) activeCount++;
                
                const hasDatabase = client.database_name && client.database_name !== 'Не создана';
                if (hasDatabase) {
                    dbCount++;
                } else {
                    noDbCount++;
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${client.id}</strong></td>
                    <td>${client.company_name || 'Не указано'}</td>
                    <td>${client.full_name || 'Не указано'}</td>
                    <td>${client.email || 'Не указано'}</td>
                    <td>${client.phone || 'Не указано'}</td>
                    <td>${client.login || 'Не указано'}</td>
                    <td>
                        <span class="badge bg-info">${client.profile_name || 'Владелец'}</span>
                    </td>
                    <td>
                        <code class="${hasDatabase ? 'text-success' : 'text-warning'}">${client.database_name || 'Не создана'}</code>
                        ${!hasDatabase ? `<br><small class="text-warning">Требуется создание БД</small>` : ''}
                    </td>
                    <td>
                        <span class="badge ${client.is_active ? 'bg-success' : 'bg-danger'}">
                            ${client.is_active ? 'Активен' : 'Неактивен'}
                        </span>
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            ${!hasDatabase ? `
                                <button class="btn btn-success me-1" onclick="createClientDatabase(${client.client_organization_id})" title="Создать БД">
                                    <i class="fas fa-database"></i>
                                </button>
                            ` : ''}
                            <button class="btn btn-outline-primary me-1" onclick="manageClient(${client.id})" title="Управление">
                                <i class="fas fa-cog"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="deactivateClient(${client.id})" title="Деактивировать">
                                <i class="fas fa-ban"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Обновляем статистику
            document.getElementById('clients-count').textContent = clients.length;
            document.getElementById('active-count').textContent = activeCount;
            document.getElementById('db-count').textContent = dbCount;
            document.getElementById('no-db-count').textContent = noDbCount;
            
            // Показываем таблицу
            document.getElementById('clients-table-container').style.display = 'block';
            
        } else {
            // Если клиентов нет, показываем состояние пустого списка
            document.getElementById('empty-state').style.display = 'block';
        }
        
    } catch (error) {
        console.error('Ошибка загрузки клиентов:', error);
        document.getElementById('loading-message').style.display = 'none';
        document.getElementById('error-message').style.display = 'block';
        document.getElementById('error-message').innerHTML = 
            `<i class="fas fa-exclamation-triangle me-2"></i>Ошибка загрузки данных: ${error.message}. <a href="javascript:location.reload()">Обновить страницу</a>`;
    }
}

// Добавление нового клиента
async function addClient() {
    const form = document.getElementById('add-client-form');
    const formData = new FormData(form);
    
    const clientData = {
        company_name: formData.get('company_name'),
        contact_person: formData.get('contact_person'),
        email: formData.get('email'),
        phone: formData.get('phone'),
        login: formData.get('login'),
        password: formData.get('password'),
        notes: formData.get('notes'),
        create_database: formData.get('create_database') === 'on'
    };
    
    // Валидация обязательных полей
    if (!clientData.company_name || !clientData.contact_person || !clientData.email || 
        !clientData.phone || !clientData.login || !clientData.password) {
        alert('Пожалуйста, заполните все обязательные поля (отмечены *)');
        return;
    }
    
    try {
        const response = await fetch('/api/admin/clients', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(clientData)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            const modal = bootstrap.Modal.getInstance(document.getElementById('addClientModal'));
            modal.hide();
            form.reset();
            loadClients(); // Перезагружаем список клиентов
            alert(result.message || 'Клиент успешно создан!');
        } else {
            alert('Ошибка: ' + (result.detail || 'Неизвестная ошибка'));
        }
    } catch (error) {
        console.error('Ошибка создания клиента:', error);
        alert('Ошибка создания клиента: ' + error.message);
    }
}

// Создание БД для клиента
async function createClientDatabase(clientOrganizationId) {
    if (!confirm('Вы уверены, что хотите создать базу данных для этого клиента?')) return;
    
    try {
        const response = await fetch(`/api/admin/clients/${clientOrganizationId}/create-database`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const result = await response.json();
        
        if (response.ok) {
            if (result.success) {
                alert(result.message);
                loadClients(); // Обновляем список клиентов
            } else {
                alert('Предупреждение: ' + result.message);
            }
        } else {
            alert('Ошибка: ' + (result.detail || 'Неизвестная ошибка'));
        }
    } catch (error) {
        console.error('Ошибка создания БД:', error);
        alert('Ошибка создания БД: ' + error.message);
    }
}

// Управление клиентом
function manageClient(clientId) {
    alert(`Управление клиентом ID: ${clientId} - этот функционал будет реализован позже`);
}

// Деактивация клиента
async function deactivateClient(clientId) {
    if (!confirm('Вы уверены, что хотите деактивировать клиента?')) return;
    
    try {
        const response = await fetch(`/api/admin/clients/${clientId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            loadClients(); // Обновляем список клиентов
            alert('Клиент деактивирован');
        } else {
            alert('Ошибка деактивации клиента');
        }
    } catch (error) {
        console.error('Ошибка деактивации клиента:', error);
        alert('Ошибка деактивации клиента');
    }
}

// Загрузка данных при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    loadClients();
});
</script>

<style>
.sidebar {
    background: linear-gradient(180deg, var(--primary-gray) 0%, #454443 100%);
    min-height: calc(100vh - 76px);
}

.nav-link.active {
    background: rgba(255, 255, 255, 0.1);
    border-left: 4px solid var(--primary-orange);
}

.btn-primary-custom {
    background: linear-gradient(135deg, var(--primary-orange) 0%, #ff4b2b 100%);
    border: none;
    border-radius: 6px;
    color: white;
    font-weight: 500;
    padding: 10px 20px;
    transition: all 0.3s ease;
}

.btn-primary-custom:hover {
    background: linear-gradient(135deg, #d42916 0%, #e6311d 100%);
    transform: translateY(-1px);
}

:root {
    --primary-gray: #555453;
    --primary-orange: #e6311d;
    --bg-color: #f8fafc;
    --surface-color: #ffffff;
    --text-primary: #323130;
    --text-secondary: #605e5c;
    --border-color: #edebe9;
    --hover-color: #f3f2f1;
}
</style>
{% endblock %}